name: Deploy to jquiroz.net

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      SSH_USER: ${{ secrets.SSH_USER }}
      SSH_HOST: ${{ secrets.SSH_HOST }}
      SITE_DIR: ${{ secrets.SITE_DIR }}
      PROJECT_DIR: ${{ secrets.PROJECT_DIR }}
      GIT_REPO_URL: ${{ secrets.GIT_REPO_URL }}
      BRANCH: main

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          echo "Host *" > ~/.ssh/config
          echo "  StrictHostKeyChecking no" >> ~/.ssh/config
      - name: Deploy on server
        run: |
          ssh "${SSH_USER}@${SSH_HOST}" "bash -s" << EOF
            set -e

            BASE_PATH="/home/${SSH_USER}/sites/${SITE_DIR}"
            PROJECT_PATH="\${BASE_PATH}/${PROJECT_DIR}"

            echo "=== Creando carpeta base si no existe: \$BASE_PATH ==="
            mkdir -p "\$BASE_PATH"

            echo "=== Entrando a carpeta del proyecto: \$PROJECT_PATH ==="
            mkdir -p "\$PROJECT_PATH"
            cd "\$PROJECT_PATH"

            # Construir nombre de proyecto y limpiarlo
            RAW_NAME="${SITE_DIR}_${PROJECT_DIR}"
            CLEAN_NAME=\$(printf "%s" "\$RAW_NAME" | tr 'A-Z' 'a-z' | tr -d ' \r\n')
            export COMPOSE_PROJECT_NAME="\$CLEAN_NAME"
            echo "COMPOSE_PROJECT_NAME=\$COMPOSE_PROJECT_NAME"

            FIRST_CLONE=0

            if [ ! -d .git ]; then
              if [ -z "\$(ls -A .)" ]; then
                echo ">>> Primera vez: clonando ${GIT_REPO_URL}"
                git clone "${GIT_REPO_URL}" .
                FIRST_CLONE=1
              else
                echo "ERROR: La carpeta \$PROJECT_PATH no está vacía y no es repo git."
                exit 1
              fi
            else
              echo ">>> Repositorio ya existente, haciendo fetch..."
              git fetch --all
            fi

            LOCAL=\$(git rev-parse HEAD || echo "")
            REMOTE=\$(git rev-parse origin/${BRANCH} || echo "")

            CHANGED=0
            if [ "\$LOCAL" != "\$REMOTE" ]; then
              echo ">>> Hay nueva versión, haciendo git pull..."
              git pull origin "${BRANCH}"
              CHANGED=1
            else
              echo ">>> Commits local y remoto son iguales."
            fi

            if [ "\$FIRST_CLONE" = "1" ] || [ "\$CHANGED" = "1" ]; then
              echo ">>> Ejecutando despliegue con Docker Compose..."
              if [ -f docker-compose.yml ] || [ -f docker-compose.yaml ]; then
                docker compose down || true
                docker compose pull || true
                docker compose up -d --build
                echo ">>> Despliegue completado."
              else
                echo ">>> No se encontró docker-compose.yml, nada que levantar."
              fi
            else
              echo ">>> No hubo cambios y no es primer despliegue. No se reinician contenedores."
            fi

            echo "=== Fin del despliegue ==="
          EOF



