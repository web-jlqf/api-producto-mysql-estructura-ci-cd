name: Deploy to jquiroz.net

on:
  push:
    branches:
      - main   # o la rama que quieres usar

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      SSH_USER: ${{ secrets.SSH_USER }}
      SSH_HOST: ${{ secrets.SSH_HOST }}
      SITE_DIR: ${{ secrets.SITE_DIR }}
      GIT_REPO_URL: ${{ secrets.GIT_REPO_URL }}
      BRANCH: main

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          echo "Host *" > ~/.ssh/config
          echo "  StrictHostKeyChecking no" >> ~/.ssh/config

      - name: Deploy on server
        run: |
          ssh "${SSH_USER}@${SSH_HOST}" "bash -s" << EOF
            set -e

            echo "=== Entrando a /home/pweb/sites ==="
            cd /home/pweb/sites

            echo "=== Creando carpeta si no existe: ${SITE_DIR} ==="
            mkdir -p "${SITE_DIR}"
            cd "${SITE_DIR}"

            echo "=== Revisando si existe .git ==="
            if [ ! -d .git ]; then
              echo ">>> Primera vez: clonando ${GIT_REPO_URL}"
              git clone "${GIT_REPO_URL}" .
            else
              echo ">>> Repositorio ya existe, haciendo fetch..."
              git fetch --all
            fi

            echo "=== Comparando commits local vs remoto ==="
            LOCAL=\$(git rev-parse HEAD || echo "")
            REMOTE=\$(git rev-parse origin/${BRANCH} || echo "")

            if [ "\$LOCAL" != "\$REMOTE" ]; then
              echo ">>> Hay nueva versión, haciendo git pull..."
              git pull origin "${BRANCH}"

              echo ">>> Verificando docker-compose..."
              if [ -f docker-compose.yml ] || [ -f docker-compose.yaml ]; then
                echo ">>> Reiniciando contenedores..."
                docker compose down
                docker compose pull || true
                docker compose up -d --build
                echo ">>> Despliegue completado."
              else
                echo ">>> No hay docker-compose, solo se actualizaron archivos."
              fi
            else
              echo ">>> El servidor ya está actualizado."
            fi

            echo "=== Fin del despliegue ==="
          EOF
